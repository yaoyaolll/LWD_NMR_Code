/*----------------------------头文件---------------------------------------------*/
#include "DSP281x_Device.h"     // DSP281x Headerfile Include File
#include "DSP281x_Examples.h"   // DSP281x Examples Include File
#include "MyHeaderFiles.h"

// SCIA_interrupt.c
Uint16 SciaDataEven;
Uint16 BufferSciaDataH;
Uint16 BufferSciaDataL;
Uint16 BufferSciaDataAll;
Uint16 SciaRecFlag = 0;

// 主控板下发数据帧帧头定义，F means Frame
#define DATA_INQUIRE_F		0x999A	// 查询状态指令
#define DATA_DOWN_TABLE_F	0x1328	// 参数表下载指令
#define DATA_UP_TABLE_F		0x1428	// 参数表上传指令
#define DATA_OPERATION_F	0x999B	// 启动工作指令
#define	DATA_CASING_F		0x999C	// 套管检测指令
#define	DATA_UP_MODE_F		0x999D	// 模式数据上传指令
#define	DATA_MODE_CONFIRM_F	0x999E	// 模式数据确认指令

// 事件板回复帧帧头定义，F means Frame
#define REPLY_STATE_F		0x9991	// 查询状态指令回复
#define REPLY_DOWN_TABLE_F 	0x9992	// 参数表下载指令回复
#define	REPLY_UP_TABLE_F	0x9993	// 参数表上传指令回复
#define REPLY_CASING_F		0x9994	// 套管检测数据
#define REPLY_MODE_DATA_F	0x9995	// 刻度测井模式数据回复
#define REPLY_CASING_ERR_F	0x9996	// 套管检测异常帧

unsigned int SciaTx_Ready(void)   //准备发送数据时为1，否则为0
{
	if(SciaRegs.SCICTL2.bit.TXRDY == 1)
		return(1);
	else
		return(0);
}

// 查询状态指令的回复帧
void ReplyStateFrame(Uint16 state)
{
	Uint16 CheckSum = 0;
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 1;    // SCIA设置为发送状态
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = REPLY_STATE_F;            
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = 3;              

	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = state;      		// 发送状态
	
	CheckSum += REPLY_STATE_F;
	CheckSum += 3;
	CheckSum += state;
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = CheckSum;          // 发送CheckSum
	
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 0;    // SCIA设置为接收状态
}

// 参数表下载指令的回复帧
void ReplyDownTableFrame(Uint16 lastCheckSum)
{
	Uint16 CheckSum = 0;
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 1;    // SCIA设置为发送状态
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = REPLY_DOWN_TABLE_F;            
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = 3;              

	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = lastCheckSum;      		// 指令的CheckSum
	
	CheckSum += REPLY_STATE_F;
	CheckSum += 3;
	CheckSum += lastCheckSum;
	
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = CheckSum;          // 发送CheckSum
	
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 0;    // SCIA设置为接收状态
}

// 参数表上传指令的回复帧
void ReplyUpTableFrame(Uint16 tableID)
{
	Uin16* addr = NULL;
	Uint16 len = 0;
	Uint16 CheckSum = 0;
	int i = 0;
	if (tableID == 2)		// 刻度模式参数表
	{
		addr = (Uint16*)0x8002;
	}
	else if (tableID == 3) 	// 测井模式参数表
	{
		addr = (Uint16*)0x8017;
	}
	len = *addr;

	while (SciaTx_Ready() == 0) {}
		SciaRegs.SCITXBUF = REPLY_UP_TABLE_F;
	for (i=0;i<len-1;++i)
	{
		while (SciaTx_Ready() == 0) {}
			SciaRegs.SCITXBUF = *addr;
		CheckSum += *addr;
		addr++;
	}
	while (SciaTx_Ready() == 0) {}
		SciaRegs.SCITXBUF = CheckSum;
	*addr = CheckSum;
}

// 套管检测数据正常时的回复帧
void ReplyCasingFrame()
{

}

// 套管检测数据异常时的回复帧
void ReplyCasingErrFrame()
{

}

void SciaSendData(Uint16 data)
{
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 1;    // SCIA设置为发送状态
	while (SciaTx_Ready() == 0) {}
	SciaRegs.SCITXBUF = data;              // 发送数据
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 0;    // SCIA设置为接收状态
}

void SciaSendDataNWords(Uint32 StartAddr,Uint32 DataNum)
{
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 1;    // SCIA设置为发送状态
	SendTempPt = (Uint16 *)(StartAddr);
	for (SendCnt=0; SendCnt<DataNum; SendCnt++)
	{
		while (SciaTx_Ready() == 0) {}
		SciaRegs.SCITXBUF = *SendTempPt++;
	}
	GpioDataRegs.GPFDAT.bit.GPIOF9 = 0;    // SCIA设置为接收状态
}

/*准备接收数据时为1，否则为0*/
unsigned int SciaRx_Ready(void)   
{
	if(SciaRegs.SCIRXST.bit.RXRDY == 1)
		return(1);
	else
		return(0);
}

interrupt void SCIRXINTA_ISR(void)     // SCI-A接收中断函数
{
	//BufferSciaDate=SciaRegs.SCIRXBUF.all;	//读8位数据
	if(SciaDataEven == 0)
	{
		SciaDataEven = 1;
		BufferSciaDataH = SciaRegs.SCIRXBUF.bit.RXDT;
		SciaRecFlag = 0;
	}
	else
	{
		SciaDataEven = 0;
		BufferSciaDataL = SciaRegs.SCIRXBUF.bit.RXDT;
		BufferSciaDataAll = (BufferSciaDataH<<8)|BufferSciaDataL;   //读取主控板发送过来的16位数据
		SciaRecFlag = 1;    							//接收到16位数的标志
	}

	// 接收到16位数据
	if (SciaRecFlag)
	{
		if	(BufferSciaDataAll==DATA_DOWN_TABLE_F || DownTableFlag==SET)           //下载参数表命令
		{
			DownloadTable(BufferSciaDataAll);
		}
		else if	(BufferSciaDataAll==DATA_UP_TABLE_F || RecSendTableFlag==SET)     //上传参数表命令
		{
			RecSendTableCommand(BufferSciaDataAll);
		}
		else if (BufferSciaDataAll == DATA_INQUIRE_F)			// 查询状态指令
		{
			ReplyStateFrame(EventBoardState);
		}
		else if	(BufferSciaDataAll == DATA_OPERATION_F)         // 启动工作指令
		{
			if (EventBoardState == IDLE_STAT)
			{
				CheckWorkMode();
				switch(WorkMode)
				{
					case 0x0001: SingleModeFlag	= SET;break;
					case 0x0002: PPModeFlag		= SET;break;
					case 0x0003: PPDIFModeFlag	= SET;break;
					case 0x0004: PPT1ModeFlag	= SET;break;
					case 0x0005: PPOFTWModeFlag	= SET;break;
					case 0x0006: PPShortModeFlag= SET;break;
					
					case 0x0008: ScanModeFlag	= SET;break;
					case 0x0009: ScaleModeFlag	= SET;break;
					case 0x000A: HoleModeFlag	= SET;break;
					case 0x000B: PulseAcqFlag	= SET;break;
					default: break;
				}
				EventBoardState = OPERATION_STAT;
				EventBoardEvents = OPERATION_ORD_EVENT;
			}

			// 回复帧
			ReplyStateFrame(EventBoardState);
		}
		else if (BufferSciaDataAll == DATA_CASING_F)		// 套管检测指令
		{
			if (EventBoardState == IDLE_STAT)
			{
				
				EventBoardState = CASING_DETECT_STAT;
			}
		}

		




		
		else if(BufferSciaDataAll==0x5028)              //储能短节连接
		{
			K1_EN = USER_ENABLE;     //K1闭合（输出高）
			K2_EN = USER_ENABLE;     //K2闭合
			HVState = HV_ON;  //表明开通状态

			SciaSendData(0x9922);

//			while(McbspaRegs.SPCR2.bit.XRDY==0)
//			{ ; }
//			McbspaRegs.DXR1.all=0x9922;     //回复
		}
		else if(BufferSciaDataAll==0x9923)              //储能短节断开
		{
		    K1_DIS = USER_DISABLE;
		    K2_DIS = USER_DISABLE;
		    HVState = HV_OFF;

		    SciaSendData(0x9923);

//	        while(McbspaRegs.SPCR2.bit.XRDY==0)
//			{ ; }
//			McbspaRegs.DXR1.all=0x9923;     //回复
		}
		else if(BufferSciaDataAll==0x9924)              //储能短节判断
		{
			GpioDataRegs.GPFDAT.bit.GPIOF9 = 1;    // SCIA设置为发送状态
			while (SciaTx_Ready() == 0) {}
			SciaRegs.SCITXBUF = 0x9924;              // 发送数据
			while (SciaTx_Ready() == 0) {}
			SciaRegs.SCITXBUF = HVState;              // 发送数据
			while (SciaTx_Ready() == 0) {}
			SciaRegs.SCITXBUF = 0xAA55;              // 发送数据
			GpioDataRegs.GPFDAT.bit.GPIOF9 = 0;    // SCIA设置为接收状态
		}
		else if(BufferSciaDataAll==0x9901)              //系统自检测
		{
			TIMER_DATA = 1;   //1个计数为
			TIMER_START = 0x1;
			Delay(60);

			if(GpioDataRegs.GPADAT.bit.GPIOA9==1)
			{
//				while(McbspaRegs.SPCR2.bit.XRDY==0)
//				{ ; }
//				McbspaRegs.DXR1.all=0x0;
				SciaSendData(0);
			}
			else
			{
//				while(McbspaRegs.SPCR2.bit.XRDY==0)
//				{ ; }
//				McbspaRegs.DXR1.all=0x0020;
				SciaSendData(0x0020);
			}
			TIMER_STOP = 0x2;
		}
	}

    SciaRegs.SCIFFRX.bit.RXFIFORESET=0;
    SciaRegs.SCIFFRX.bit.RXFIFORESET=1;
	SciaRegs.SCIFFRX.bit.RXFFINTCLR=1;

	PieCtrlRegs.PIEACK.all = PIEACK_GROUP9;

//	GpioDataRegs.GPFDAT.bit.GPIOF11=1;
	EINT;
//		SciaRegs.SCICTL1.bit.SLEEP = 1;			//更改完成，结束 485 总线上 地址
	return;
}

